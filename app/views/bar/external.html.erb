var socket = {};
var blinkmarks = function(){
	
	var REMOTE = "<%= root_url %>"
		,head = document.getElementsByTagName('head')[0]
		,deps = 0
		,finished_deps = 0
		,bar_built = false
		;
	
	//Function for building the bar	
	function buildBar(){
				
		//remove the bar if its already rendered		
		if(jQuery('div#blinkmarks').length > 0){ 
			jQuery('div#blinkmarks')[0].slideUp('fast', function(){
				$(this).remove();
				bar_built = false;
			});
			return false;
		}
		
		jQuery.noConflict();
		jQuery(function($){ 
			if(bar_built === false){
				var $barDiv = $('<div id="blinkmarks"></div>')
					,$closeBtn = $('<a href="#">X</a>')
					;	
				
				$barDiv.css({
					width: '100%',
					height: '30px',
					border: 'none',
					padding: '0',
					margin: '0',
					position: 'fixed',
					'padding': "5px 0",
					top: "0px",
					left: "0px",
					display: 'none',
					'z-index': "9001",
					'background-color': '#FFF'
				});
			
	
				$closeBtn.css({
					float: 'right',
					"padding-right": "10px"
				});
				$closeBtn.click(function(){
					$barDiv.slideUp('fast', function(){
						$barDiv.remove();
					});
					return false;
				});
			
				//add a small style sheet to the host head. because easyxdm won't let us set the styles of the iframe it generates
				$(head).append("<style type=\"text/css\">#easyXDM_default0_provider{ float: left;}</style>");
				$barDiv.append($closeBtn);
				$('body').prepend($barDiv);
			
			
				var rpc = new easyXDM.Rpc({
				    remote: REMOTE+"/frame", // the path to the provider
						container: $barDiv.get(0),
						props : {
							name : window.location.href+"||"+window.document.title,
							width : '90%',
							height : '30px',
							scrolling : 'no',
							class : "easyxdm",
							frameborder : '0',
							style: {
								float: "left",
								width: "90%",
								"padding-left" : "10px",
							}
						}
				}, 
				{
				    local: {
								buildList : function(results_array, successFn, errorFn){
									var $linkList = $("<ul id='blinkmarks_search_list'/>");
									$linkList.css({
										position: 'static',
										top: '30px',
										right: '0px',
										'z-index': "9001"
									});
									for(var i=0; i<results_array.length; i++){
										$linkList.append('<li><a href="'+results_array[i].url+'">"'+results_array[i].title+'"</a></li>');
									}
									
									if($("#blinkmarks_serach_list").length <= 0){
										$('body').prepend($linkList);
									}else{
									
									}
								}
				    }
				});
						
				$barDiv.slideDown('fast', function(){ bar_built = true;});
			}
		});
	}
	
	
	/*
	*
	* Lets load 3rd party dependencys form external domains!
	*
	*/	
	
	function scriptOnLoad(){
		if(typeof jQuery == "undefined" || !jQuery ||
		   typeof easyXDM == "undefined" || !easyXDM ||
		   typeof JSON == "undefined" || !JSON){
			return;
		}
			buildBar();
	}
	
	//If there is no jquery on the page load the latest
	if(typeof jQuery == 'undefined' || !jQuery){
		var s=document.createElement('script');
		s.setAttribute('type', "text/javascript");
		s.setAttribute('src','http://jquery.com/src/jquery-latest.js');
		head.appendChild(s);
		s.onload = buildBar;
		s.onreadystatechange = function () {
			if (this.readyState == 'complete' || this.readyState == 'loaded'){
				scriptOnLoad();
			}
		};
	}
	
	//We need easyXDM to reach out of our frame 
	if(typeof easyXDM === "undefined" || !easyXDM){
		s1 = document.createElement("script");
	    s1.type = "text/javascript";
	    s1.src = REMOTE + "javascripts/easyXDM-2.4.9.102/easyXDM.debug.js";
		s1.onload = scriptOnLoad;
	    s1.onreadystatechange = function(){
	        if (this.readyState === "complete" || this.readyState === "loaded") {
	            scriptOnLoad();
	        }
	    };
	    head.appendChild(s1);
	}
	
	//I think easyXDM needs JSON
	if (typeof JSON === "undefined" || !JSON) {
        s2 = document.createElement("script");
        s2.type = "text/javascript";
        s2.src = REMOTE + "javascripts/easyXDM-2.4.9.102/json2.js";
		s2.onload = scriptOnLoad;
        s2.onreadystatechange = function(){
            if (this.readyState === "complete" || this.readyState === "loaded") {
                scriptOnLoad();
            }
        };
        head.appendChild(s2);
    }
	
			
	//public api
	return $.extend(rpc, { 
		buildBar : buildBar
	});
}();